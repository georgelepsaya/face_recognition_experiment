<!doctype html>
<html lang="en">

<head>
  <title>Face recognition</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://unpkg.com/jspsych@7.3.4"></script>

  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

  <style>
    .jspsych-btn {
      font-size: 18px;
      padding: 15px 30px;
      margin: 10px;
      min-width: 100px;
      cursor: pointer;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      border: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    #jspsych-image-button-response-stimulus {
      display: block;
      margin: 0 auto;
      max-width: 95%;
    }

    .jspsych-btn:hover {
      background-color: #45a049;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .question-text {
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    .button-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .fixation {
      font-size: 60px;
      text-align: center;
      line-height: 1;
    }

    @media (max-width: 600px) {
      .jspsych-btn {
        font-size: 16px;
        padding: 12px 25px;
        min-width: 80px;
      }

      .question-text {
        font-size: 20px;
      }
    }
  </style>
</head>

<body>
  <script type='text/javascript'>

    // Initialise jsPsych
    var jsPsych = initJsPsych({
      on_finish: function () {
        jsPsych.data.displayData();
      }
    });

    // Generate a unique filename
    const subject_id = jsPsych.randomization.randomID(12);
    const filename = `${subject_id}.csv`;

    // Create the timeline
    var timeline = [];

    // Preload images
    var preload = {
      type: jsPsychPreload,
      images: ['images/control/image_1_mb2_gb2.jpg',
                'images/control/image_2_gn3.jpg',
                'images/control/image_3_mb3.jpg',
                'images/control/image_4_gn2.jpg',
                'images/control/image_5_mb2_gn2.jpg',
                'images/control/image_6_gn2_p2.jpg',
                'images/control/image_7_gb1.jpg',
                'images/control/image_8_p3.jpg',
                'images/control/image_9_gb2.jpg',
                'images/control/image_10_gb3.jpg',
                'images/control/image_11_mb1.jpg',
                'images/control/image_12_gn2_gb2.jpg',
                'images/control/image_13_mb2.jpg',
                'images/control/image_14_gb2_p2.jpg',
                'images/control/image_15_p1.jpg',
                'images/control/image_16_gn1.jpg',
                'images/control/image_17_mb2_p2.jpg',
                'images/control/image_18_p2.jpg',
                'images/target/image_1_mb2_gb2.jpg',
                'images/target/image_2_gn3.jpg',
                'images/target/image_3_mb3.jpg',
                'images/target/image_4_gn2.jpg',
                'images/target/image_5_mb2_gn2.jpg',
                'images/target/image_6_gn2_p2.jpg',
                'images/target/image_7_gb1.jpg',
                'images/target/image_8_p3.jpg',
                'images/target/image_9_gb2.jpg',
                'images/target/image_10_gb3.jpg',
                'images/target/image_11_mb1.jpg',
                'images/target/image_12_gn2_gb2.jpg',
                'images/target/image_13_mb2.jpg',
                'images/target/image_14_gb2_p2.jpg',
                'images/target/image_15_p1.jpg',
                'images/target/image_16_gn1.jpg',
                'images/target/image_17_mb2_p2.jpg',
                'images/target/image_18_p2.jpg'
              ]
    }
    timeline.push(preload);

    // Define welcome message trial
    var welcome = {
      type: jsPsychHtmlButtonResponse,
      stimulus: "<h2>Welcome to the experiment</h2><p>Press the button below to begin.</p>",
      choices: ['Begin']
    };
    timeline.push(welcome);

    // Define instructions trial
    var instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: "<div style='max-width: 700px; margin: 0 auto; text-align: center;'>" +
        "<p>In this experiment you will be presented with faces.</p>" +
        "<p>Click <strong>'Yes'</strong> if you recognize the person</p>" +
        "<p>Click <strong>'No'</strong> if you don't recognize the person</p>" +
        "<p>Please respond as quickly and accurately as possible.</p>" +
        "</div>",
      choices: ['Start Experiment'],
      post_trial_gap: 200
    };
    timeline.push(instructions);

    // Define test stimuli: image and correct response
    var test_stimuli = [
      // control images
      {
        stimulus: "images/control/image_1_mb2_gb2.jpg",
        effects: ["motion_blur_2", "gaussian_blur_2"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_2_gn3.jpg",
        effects: ["gaussian_noise_3"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_3_mb3.jpg",
        effects: ["motion_blur_3"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_4_gn2.jpg",
        effects: ["gaussian_noise_2"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_5_mb2_gn2.jpg",
        effects: ["motion_blur_2", "gaussian_noise_2"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_6_gn2_p2.jpg",
        effects: ["gaussian_noise_2", "pixelation_2"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_7_gb1.jpg",
        effects: ["gaussian_blur_1"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_8_p3.jpg",
        effects: ["pixelation_3"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_9_gb2.jpg",
        effects: ["gaussian_blur_2"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_10_gb3.jpg",
        effects: ["gaussian_blur_3"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_11_mb1.jpg",
        effects: ["motion_blur_1"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_12_gn2_gb2.jpg",
        effects: ["gaussian_noise_2", "gaussian_blur_2"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_13_mb2.jpg",
        effects: ["motion_blur_2"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_14_gb2_p2.jpg",
        effects: ["gaussian_blur_2", "pixelation_2"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_15_p1.jpg",
        effects: ["pixelation_1"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_16_gn1.jpg",
        effects: ["gaussian_noise_1"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_17_mb2_p2.jpg",
        effects: ["motion_blur_2", "pixelation_2"],
        correct_response: 1
      },
      {
        stimulus: "images/control/image_18_p2.jpg",
        effects: ["pixelation_2"],
        correct_response: 1
      },
      // target images
      {
        stimulus: "images/target/image_1_mb2_gb2.jpg",
        effects: ["motion_blur_2", "gaussian_blur_2"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_2_gn3.jpg",
        effects: ["gaussian_noise_3"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_3_mb3.jpg",
        effects: ["motion_blur_3"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_4_gn2.jpg",
        effects: ["gaussian_noise_2"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_5_mb2_gn2.jpg",
        effects: ["motion_blur_2", "gaussian_noise_2"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_6_gn2_p2.jpg",
        effects: ["gaussian_noise_2", "pixelation_2"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_7_gb1.jpg",
        effects: ["gaussian_blur_1"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_8_p3.jpg",
        effects: ["pixelation_3"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_9_gb2.jpg",
        effects: ["gaussian_blur_2"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_10_gb3.jpg",
        effects: ["gaussian_blur_3"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_11_mb1.jpg",
        effects: ["motion_blur_1"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_12_gn2_gb2.jpg",
        effects: ["gaussian_noise_2", "gaussian_blur_2"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_13_mb2.jpg",
        effects: ["motion_blur_2"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_14_gb2_p2.jpg",
        effects: ["gaussian_blur_2", "pixelation_2"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_15_p1.jpg",
        effects: ["pixelation_1"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_16_gn1.jpg",
        effects: ["gaussian_noise_1"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_17_mb2_p2.jpg",
        effects: ["motion_blur_2", "pixelation_2"],
        correct_response: 0
      },
      {
        stimulus: "images/target/image_18_p2.jpg",
        effects: ["pixelation_2"],
        correct_response: 0
      },
    ]

    // Create fixation trial
    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size: 60px">+</div>',
      choices: 'NO_KEYS',
      trial_duration: 200,
      data: {
        task: 'fixation'
      }
    }

    // Create test trial
    var test = {
      type: jsPsychImageButtonResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: ['Yes', 'No'],
      data: {
        task: 'response',
        effects: jsPsych.timelineVariable('effects'),
        correct_response: jsPsych.timelineVariable('correct_response')
      },
      on_finish: function(data) {
        data.correct = data.response === data.correct_response;
      }
    }

    // Define the test procedure
    var test_procedure = {
      timeline: [fixation, test],
      timeline_variables: test_stimuli,
      randomize_order: true
    }

    // Add randomized test trials to the timeline
    timeline.push(test_procedure);

    // Control question options
    var control_options = [
        "I know all people listed below",
        "<img src='images/real/image_1.jpg'>",
        "<img src='images/real/image_2.jpg'>",
        "<img src='images/real/image_3.jpg'>",
        "<img src='images/real/image_4.jpg'>",
        "<img src='images/real/image_5.jpg'>",
        "<img src='images/real/image_6.jpg'>",
        "<img src='images/real/image_7.jpg'>",
        "<img src='images/real/image_8.jpg'>",
        "<img src='images/real/image_9.jpg'>",
        "<img src='images/real/image_10.jpg'>",
        "<img src='images/real/image_11.jpg'>",
        "<img src='images/real/image_12.jpg'>",
        "<img src='images/real/image_13.jpg'>",
        "<img src='images/real/image_14.jpg'>",
        "<img src='images/real/image_15.jpg'>",
        "<img src='images/real/image_16.jpg'>",
        "<img src='images/real/image_17.jpg'>",
        "<img src='images/real/image_18.jpg'>",
    ]

    // Control question trial
    var control_trial = {
      type: jsPsychSurveyMultiSelect,
      questions: [
        {
          prompt: "Select faces you do <strong>not</strong> know (if there are any)",
          options: control_options,
          required: true,
          name: 'faces'
        }
      ]
    };
    timeline.push(control_trial);

    // Create a debrief block
    var debrief_block = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        var trials = jsPsych.data.get().filter({task: 'response'});
        var correct_trials = trials.filter({correct: true});
        var accuracy = Math.round(correct_trials.count() / trials.count() * 100);

        return `<div style='text-align: center;'>
          <h2>Thank you for participating!</h2>
          <p>You responded correctly on ${accuracy}% of the trials.</p>
          <p>Press the button below to complete the experiment.</p>
          </div>`;
      },
      choices: ['Finish']
    };
    timeline.push(debrief_block);


    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "fbUFLzC3kj50",
      filename: filename,
      data_string: ()=>jsPsych.data.get().csv()
    };

    /* start the experiment */
    jsPsych.run(timeline);

  </script>
</body>

</html>
